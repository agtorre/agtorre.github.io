<!doctype html><html lang=en><head><title>Aaron's Desk Chair Adventures</title><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="The HTML5 Herald"><meta name=author content="Aaron Torres"><meta property="og:title" content="Go Handlers and State"><meta property="og:description" content="Today I&rsquo;d like to get a bit technical about things I&rsquo;ve been learning and working on in the Go language
Sometimes it&rsquo;s helpful to pass additional state into a web handler function."><meta property="og:type" content="article"><meta property="og:url" content="https://www.aaron-torres.com/post/handlers-and-state/"><meta property="article:published_time" content="2015-06-14T00:00:00+00:00"><meta property="article:modified_time" content="2015-06-14T00:00:00+00:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="Go Handlers and State"><meta name=twitter:description content="Today I&rsquo;d like to get a bit technical about things I&rsquo;ve been learning and working on in the Go language
Sometimes it&rsquo;s helpful to pass additional state into a web handler function."><meta name=generator content="Hugo 0.70.0-DEV"><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/normalize/8.0.1/normalize.min.css integrity="sha256-l85OmPOjvil/SOvVt3HnSSjzF1TUMyT9eV0c2BzEGzU=" crossorigin=anonymous><link rel=stylesheet href=https://www.aaron-torres.com/fontawesome/css/all.min.css><link rel=stylesheet href="https://fonts.googleapis.com/css?family=Roboto+Slab|Ruda"><link rel=stylesheet type=text/css href=/css/styles.css><link rel=stylesheet href=https://www.aaron-torres.com/css/tmp.css></head><body><div id=container><header><h1><a href=/>Aaron&rsquo;s Desk Chair Adventures</a></h1><ul id=social-media><li><a href=mailto:me@aaron-torres.com title="Email me"><i class="fas fa-envelope fa-lg"></i></a></li><li><a href=https://github.com/agtorre title=GitHub><i class="fab fa-github fa-lg"></i></a></li><li><a href=https://twitter.com/aarontorres title=Twitter><i class="fab fa-twitter fa-lg"></i></a></li><li><a href=https://linkedin.com/in/torresaaron title=LinkedIn><i class="fab fa-linkedin fa-lg"></i></a></li></ul><p><em>Code. Engineering Management. Fun.</em></p></header><nav><ul><li><a href=/post><i class="fa-li fa fa-lg"></i><span>Archive</span></a></li><li><a href=/tags><i class="fa-li fa fa-lg"></i><span>Tags</span></a></li></ul></nav><main><article><h1>Go Handlers and State</h1><aside><ul><li><time class=post-date datetime=2015-06-14T00:00:00Z>Jun 14, 2015</time></li><li><em><a href=/tags/development>#development</a>
,
<a href=/tags/golang>#golang</a></em></li><li>3 minutes read</li></ul></aside><p>Today I&rsquo;d like to get a bit technical about things I&rsquo;ve been learning and working on in the Go language</p><p>Sometimes it&rsquo;s helpful to pass additional state into a <a href=http://golang.org/pkg/net/http/#HandlerFunc>web handler function</a>. For all the examples below, lets assume you want to have a toggle for authentication that is checked once within the handler function. These functions have a specific signature and make it difficult to both add parameters and remain compatible with other libraries. There are many ways to accomplish this, including middleware with some combination of <a href=https://github.com/codegangsta/negroni>middleware</a> and <a href=http://www.gorillatoolkit.org/pkg/context>context</a> libraries. This has the advantage of allowing each request to modify the stored context value without interfering with other handlers. It&rsquo;s a bit complicated if you happen to forget to turn on the middleware and requires a diligent programmer to not hit panics inside the handler by implementing functions like DoAuth below.</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>key</span> <span style=color:#66d9ef>int</span>

<span style=color:#66d9ef>const</span> <span style=color:#a6e22e>AuthKey</span> <span style=color:#a6e22e>key</span> = <span style=color:#ae81ff>0</span>

<span style=color:#66d9ef>func</span> <span style=color:#a6e22e>UseAuth</span>(<span style=color:#a6e22e>w</span> <span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>ResponseWriter</span>, <span style=color:#a6e22e>r</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>Request</span>, <span style=color:#a6e22e>next</span> <span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>HandlerFunc</span>){
    <span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>Set</span>(<span style=color:#a6e22e>r</span>, <span style=color:#a6e22e>AuthKey</span>, <span style=color:#66d9ef>true</span>)
    <span style=color:#a6e22e>next</span>(<span style=color:#a6e22e>w</span>, <span style=color:#a6e22e>r</span>)
    <span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>Clear</span>(<span style=color:#a6e22e>r</span>)
}

<span style=color:#66d9ef>func</span> <span style=color:#a6e22e>DoAuth</span>(<span style=color:#a6e22e>r</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>Request</span>)(<span style=color:#66d9ef>bool</span>, <span style=color:#66d9ef>error</span>){
    <span style=color:#75715e>// in case middle-ware isn&#39;t turned on...
</span><span style=color:#75715e></span>    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>doAuth</span>, <span style=color:#a6e22e>ok</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>Get</span>(<span style=color:#a6e22e>r</span>, <span style=color:#a6e22e>AuthKey</span>); <span style=color:#a6e22e>ok</span>{
        <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>doAuth</span>, <span style=color:#66d9ef>nil</span>
    }
    <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>false</span>, <span style=color:#a6e22e>errors</span>.<span style=color:#a6e22e>New</span>(<span style=color:#e6db74>&#34;middleware off&#34;</span>)
}

<span style=color:#66d9ef>func</span> <span style=color:#a6e22e>AllTheInfo</span>(<span style=color:#a6e22e>w</span> <span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>ResponseWriter</span>, <span style=color:#a6e22e>r</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>Request</span>){
    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>doAuth</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>DoAuth</span>(<span style=color:#a6e22e>r</span>); <span style=color:#a6e22e>err</span> <span style=color:#f92672>==</span> <span style=color:#66d9ef>nil</span> <span style=color:#f92672>&amp;&amp;</span> <span style=color:#a6e22e>doAuth</span>{
        <span style=color:#75715e>// do something here
</span><span style=color:#75715e></span>    }
}

<span style=color:#66d9ef>func</span> <span style=color:#a6e22e>main</span>(){
    <span style=color:#a6e22e>n</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>negroni</span>.<span style=color:#a6e22e>New</span>()
    <span style=color:#a6e22e>n</span>.<span style=color:#a6e22e>Use</span>(<span style=color:#a6e22e>UseAuth</span>)

    <span style=color:#a6e22e>mux</span> = <span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>NewServeMux</span>()
    <span style=color:#a6e22e>mux</span>.<span style=color:#a6e22e>HandleFunc</span>(<span style=color:#e6db74>&#34;/&#34;</span>, <span style=color:#a6e22e>AllTheInfo</span>)

    <span style=color:#a6e22e>n</span>.<span style=color:#a6e22e>UseHandler</span>(<span style=color:#a6e22e>mux</span>)
    <span style=color:#a6e22e>n</span>.<span style=color:#a6e22e>Run</span>(<span style=color:#e6db74>&#34;:8000&#34;</span>)
}
</code></pre></div><p>A simpler, but potentially less flexible approach is to use controllers. It&rsquo;s important to remember and keep in mind that controller variables should not be modified inside the handler as it will modify the controller for all other handlers that make use of it. For example, it may seem tempting to set some state based on the current request, but this is not recommended out of the box. Some examples of packages that get around this limitation by creating a controller each request include <a href=https://github.com/gocraft/web>gocraft/web</a> and this <a href=https://github.com/codegangsta/controller>controller</a> library.</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>Controller</span> <span style=color:#66d9ef>struct</span>{
    <span style=color:#a6e22e>DoAuth</span> <span style=color:#66d9ef>bool</span>
}

<span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>c</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>Controller</span>) <span style=color:#a6e22e>AllTheInfo</span>(<span style=color:#a6e22e>w</span> <span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>ResponseWriter</span>, <span style=color:#a6e22e>r</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>Request</span>){
    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>DoAuth</span>{
        <span style=color:#75715e>// do something here
</span><span style=color:#75715e></span>    }
}

<span style=color:#66d9ef>func</span> <span style=color:#a6e22e>main</span>(){
    <span style=color:#a6e22e>c</span> <span style=color:#f92672>:=</span> <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>Controller</span>{<span style=color:#a6e22e>DoAuth</span>: <span style=color:#66d9ef>true</span>}
    <span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>HandleFunc</span>(<span style=color:#e6db74>&#34;/&#34;</span>, <span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>AllTheInfo</span>)
    <span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>ListenAndServe</span>(<span style=color:#e6db74>&#34;:8000&#34;</span>, <span style=color:#66d9ef>nil</span>)
}
</code></pre></div><p>Finally, a very light-weight approach I like to make use of is closures. Closures allow the state to be modified from within the handler and are also granular enough that you can tweak them for every route without initializing additional controllers or wrapping every route with middleware incurring context look-up and reflection overhead.</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>CheckAllTheInfo</span>(<span style=color:#a6e22e>DoAuth</span> <span style=color:#66d9ef>bool</span>) <span style=color:#66d9ef>func</span>(<span style=color:#a6e22e>w</span> <span style=color:#a6e22e>ResponseWriter</span>, <span style=color:#a6e22e>r</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>Request</span>){
    <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>func</span>(<span style=color:#a6e22e>w</span> <span style=color:#a6e22e>ResponseWriter</span>, <span style=color:#a6e22e>r</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>Request</span>){
        <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>DoAuth</span>{
            <span style=color:#75715e>// do something here
</span><span style=color:#75715e></span>        }
    }
}

<span style=color:#66d9ef>func</span> <span style=color:#a6e22e>main</span>(){
    <span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>HandleFunc</span>(<span style=color:#e6db74>&#34;/&#34;</span>, <span style=color:#a6e22e>CheckAllTheInfo</span>(<span style=color:#66d9ef>true</span>))
    <span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>ListenAndServe</span>(<span style=color:#e6db74>&#34;:8000&#34;</span>, <span style=color:#66d9ef>nil</span>)
}
</code></pre></div><p>Overall, there&rsquo;s a lot of ways to accomplish injecting state for web handler functions in Go. There are a number of other middleware packages besides negroni and there are even context objects build into the <a href=https://godoc.org/golang.org/x/net/context>standard library</a> now. I use combinations of all of these as one doesn&rsquo;t scratch all the itches I have. You can also combine these, for example you could attach a context object to a controller that is safe to modify or wrap a controller method in a closure.</p></article><section class=post-nav><ul><li><a href=https://www.aaron-torres.com/post/moving-forward/><i class="fa fa-chevron-circle-left"></i>Looking and Moving Forward</a></li><li><a href=https://www.aaron-torres.com/post/validation-tricks/>Go Validation Tricks <i class="fa fa-chevron-circle-right"></i></a></li></ul></section></main><footer><h6>Copyright © 2020 - Aaron Torres |
Rendered by <a href=https://gohugo.io title=Hugo>Hugo</a> |
<a href=https://www.aaron-torres.comindex.xml>Subscribe</a></h6></footer></div><script src=/js/scripts.js></script><script type=application/javascript>var doNotTrack=false;if(!doNotTrack){window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;ga('create','UA-8973677-3','auto');ga('send','pageview');}</script><script async src=https://www.google-analytics.com/analytics.js></script></body></html>