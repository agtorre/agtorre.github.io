  <!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en-us">
<head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8">
    
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">
    <title> Go Handlers and State &middot; Aaron Torres </title>
    
    <link rel="stylesheet" type="text/css" href="http://www.aaron-torres.com//css/uno.min.css" />
    <link rel="stylesheet" type="text/css" href="http://www.aaron-torres.com//css/lightGallery.css" />
    <style>
        a{
            color: #b58900;
        }

    </style>
    
    <link rel="apple-touch-icon-precomposed" sizes="144x144" href="/apple-touch-icon-144-precomposed.png">
    <link rel="shortcut icon" href="/favicon.ico">
    
    <link href="" rel="alternate" type="application/rss+xml" title="Aaron Torres" />
    
    <script src="http://www.aaron-torres.com//js/jquery.min.js"></script>
    <script src="http://www.aaron-torres.com//js/main.min.js">
    <!-- syntax highlighting -->
    <link rel="stylesheet" href="https://yandex.st/highlightjs/8.0/styles/default.min.css">
    <script src="https://yandex.st/highlightjs/8.0/highlight.min.js"></script>
    <script>hljs.initHighlightingOnLoad();</script>
    </script>
</head>

  <body>
    <span class="mobile btn-mobile-menu">
        <i class="fa fa-bars btn-mobile-menu__icon"></i>
        <i class="fa fa-times btn-mobile-close__icon hidden"></i>
    </span>
<header class="panel-cover panel-cover--collapsed"  style="background-image: url(/images/background-cover.jpg)" >
    <div class="panel-main">
        <div class="panel-main__inner panel-inverted">
            <div class="panel-main__content"> 
                <h1 class="panel-cover__title panel-title">
                    <a href="http://www.aaron-torres.com/" title="link to homepage for Aaron Torres">Aaron Torres</a>
                </h1>
                <hr class="panel-cover__divider" />
                <p class="panel-cover__description">  A collection of writing, projects, and whatever else I feel like.  </p>
                <hr class="panel-cover__divider panel-cover__divider--secondary" />
                <div class="navigation-wrapper">
                    <nav class="cover-navigation cover-navigation--primary">
                        <ul class="navigation">
                            <li class="navigation__item"><a href="/#blog" title="link to Aaron Torres blog" class="blog-button">Blog</a> </li>
                            </br>  </ul>
                    </nav> <nav class="cover-navigation navigation--social">
    <ul class="navigation"> 
        
        <li class="navigation__item">
            <a href="http://twitter.com/aarontorres" title="@aarontorres on Twitter"> <i class='fa fa-tt'></i> <span class="label">Twitter</span> </a>
        </li>   
        
        <li class="navigation__item">
            <a href="https://github.com/agtorre" title="agtorre on github"> <i class='fa fa-github'></i> <span class="label">Github</span> </a>
        </li>  </br>  
        
        <li class="navigation__item">
            <a href="http://no.linkedin.com/in/torresaaron/en" title="Linkedin"> <i class='fa fa-ll'></i> <span class="label">Linkedin</span> </a>
        </li>  
        
        <li class="navigation__item">
            <a href="mailto:me@aaron-torres.com" title="Email me@aaron-torres.com"> <i class='fa fa-envelope-o'></i> <span class="label">Email</span> </a>
        </li>  </ul>
</nav>
 </div>
            </div>
        </div>
        <div class="panel-cover--overlay"></div>
    </div>
</header>

    <div class="content-wrapper">
      <div class="content-wrapper__inner">
        <div class="post">
          <h1>Go Handlers and State</h1>
          <span class="post-date">Sun, Jun 14, 2015</span>
          <p>Today I&rsquo;d like to get a bit technical about things I&rsquo;ve been learning and working on in the Go language</p>

<p>Sometimes it&rsquo;s helpful to pass additional state into a <a href="http://golang.org/pkg/net/http/#HandlerFunc">web handler function</a>. For all the examples below, lets assume you want to have a toggle
for authentication that is checked once within the handler function. These functions have a specific signature and make it difficult to both add parameters and remain compatible with other libraries.
There are many ways to accomplish this, including middleware with some combination of <a href="https://github.com/codegangsta/negroni">middleware</a> and <a href="http://www.gorillatoolkit.org/pkg/context">context</a> libraries.
This has the advantage of allowing each request to modify the stored context value without interfering with other handlers. It&rsquo;s a bit complicated if you happen to forget to turn on the middleware
and requires a diligent programmer to not hit panics inside the handler by implementing functions like DoAuth below.</p>

<pre><code class="language-go">type key int

const AuthKey key = 0

func UseAuth(w http.ResponseWriter, r *http.Request, next http.HandlerFunc){
    context.Set(r, AuthKey, true)
    next(w, r)
    context.Clear(r)
}

func DoAuth(r *http.Request)(bool, error){
    // in case middle-ware isn't turned on...
    if doAuth, ok := context.Get(r, AuthKey); ok{
        return doAuth, nil
    }
    return false, errors.New(&quot;middleware off&quot;)
}

func AllTheInfo(w http.ResponseWriter, r *http.Request){
    if doAuth, err := DoAuth(r); err == nil &amp;&amp; doAuth{
        // do something here
    }
}

func main(){
    n := negroni.New()
    n.Use(UseAuth)

    mux = http.NewServeMux()
    mux.HandleFunc(&quot;/&quot;, AllTheInfo)

    n.UseHandler(mux)
    n.Run(&quot;:8000&quot;)
}
</code></pre>

<p>A simpler, but potentially less flexible approach is to use controllers. It&rsquo;s important to remember and keep in mind that
controller variables should not be modified inside the handler as it will modify the controller for all other handlers that make use of it. For example, it may seem tempting to set some state
based on the current request, but this is not recommended out of the box. Some examples of packages that get around this limitation by creating a controller each request include <a href="https://github.com/gocraft/web">gocraft/web</a>
and this <a href="https://github.com/codegangsta/controller">controller</a> library.</p>

<pre><code class="language-go">type Controller struct{
    DoAuth bool
}

func (c *Controller) AllTheInfo(w http.ResponseWriter, r *http.Request){
    if c.DoAuth{
        // do something here
    }
}

func main(){
    c := &amp;Controller{DoAuth: true}
    http.HandleFunc(&quot;/&quot;, c.AllTheInfo)
    http.ListenAndServe(&quot;:8000&quot;, nil)
}
</code></pre>

<p>Finally, a very light-weight approach I like to make use of is closures. Closures allow the state to be modified from within the handler and are also granular enough that you can tweak them for every route
without initializing additional controllers or wrapping every route with middleware incurring context look-up and reflection overhead.</p>

<pre><code class="language-go">func CheckAllTheInfo(DoAuth bool) func(w ResponseWriter, r *Request){
    return func(w ResponseWriter, r *Request){
        if DoAuth{
            // do something here
        }
    }
}

func main(){
    http.HandleFunc(&quot;/&quot;, CheckAllTheInfo(true))
    http.ListenAndServe(&quot;:8000&quot;, nil)
}
</code></pre>

<p>Overall, there&rsquo;s a lot of ways to accomplish injecting state for web handler functions in Go. There are a number of other middleware packages besides negroni and there are even context objects
build into the <a href="https://godoc.org/golang.org/x/net/context">standard library</a> now. I use combinations of all of these as one doesn&rsquo;t scratch all the itches I have. You can also combine these, for example
you could attach a context object to a controller that is safe to modify or wrap a controller method in a closure.</p>

        </div>
        <aside id=comments>
    <div><h2> Comments </h2></div>
<div id="disqus_thread"></div>
<script type="text/javascript">
    var disqus_shortname = 'aaron-torres';
    var disqus_identifier = 'http:\/\/www.aaron-torres.com\/post\/handlers-and-state\/';
    var disqus_title = 'Go Handlers and State';
    var disqus_url = 'http:\/\/www.aaron-torres.com\/post\/handlers-and-state\/';

    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
</aside>

      </div>
    </div>
  </body>
  <script type="text/javascript">
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
   (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
     m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
       })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-8973677-3', 'aaron-torres.com');
  ga('send', 'pageview');

(function(){var j=function(a,b){return window.getComputedStyle?getComputedStyle(a).getPropertyValue(b):a.currentStyle[b]};var k=function(a,b,c){if(a.addEventListener)a.addEventListener(b,c,false);else a.attachEvent('on'+b,c)};var l=function(a,b){for(key in b)if(b.hasOwnProperty(key))a[key]=b[key];return a};window.fitText=function(d,e,f){var g=l({'minFontSize':-1/0,'maxFontSize':1/0},f);var h=function(a){var b=e||1;var c=function(){a.style.fontSize=Math.max(Math.min(a.clientWidth/(b*10),parseFloat(g.maxFontSize)),parseFloat(g.minFontSize))+'px'};c();k(window,'resize',c)};if(d.length)for(var i=0;i<d.length;i++)h(d[i]);else h(d);return d}})();
fitText(document.getElementById('title'), 1)
</script>

<link rel="stylesheet" href="https://yandex.st/highlightjs/8.0/styles/solarized_dark.min.css">
<script src="https://yandex.st/highlightjs/8.0/highlight.min.js"></script>
<script>hljs.initHighlightingOnLoad();</script>

</html>
