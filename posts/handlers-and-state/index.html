<!doctype html><html lang=en-us><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta http-equiv=x-ua-compatible content="ie=edge"><meta name=theme-color content="#494f5c"><meta name=msapplication-TileColor content="#494f5c"><meta itemprop=name content="Go Handlers and State"><meta itemprop=description content="Today I&rsquo;d like to get a bit technical about things I&rsquo;ve been learning and working on in the Go language
Sometimes it&rsquo;s helpful to pass additional state into a web handler function. For all the examples below, lets assume you want to have a toggle for authentication that is checked once within the handler function. These functions have a specific signature and make it difficult to both add parameters and remain compatible with other libraries."><meta itemprop=datePublished content="2015-06-14T00:00:00+00:00"><meta itemprop=dateModified content="2015-06-14T00:00:00+00:00"><meta itemprop=wordCount content="512"><meta itemprop=keywords content="development,golang,"><meta property="og:title" content="Go Handlers and State"><meta property="og:description" content="Today I&rsquo;d like to get a bit technical about things I&rsquo;ve been learning and working on in the Go language
Sometimes it&rsquo;s helpful to pass additional state into a web handler function. For all the examples below, lets assume you want to have a toggle for authentication that is checked once within the handler function. These functions have a specific signature and make it difficult to both add parameters and remain compatible with other libraries."><meta property="og:type" content="article"><meta property="og:url" content="https://www.aaron-torres.com/posts/handlers-and-state/"><meta property="article:published_time" content="2015-06-14T00:00:00+00:00"><meta property="article:modified_time" content="2015-06-14T00:00:00+00:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="Go Handlers and State"><meta name=twitter:description content="Today I&rsquo;d like to get a bit technical about things I&rsquo;ve been learning and working on in the Go language
Sometimes it&rsquo;s helpful to pass additional state into a web handler function. For all the examples below, lets assume you want to have a toggle for authentication that is checked once within the handler function. These functions have a specific signature and make it difficult to both add parameters and remain compatible with other libraries."><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=manifest href=/site.webmanifest><link rel=mask-icon href=/safari-pinned-tab.svg color><link rel="shortcut icon" href=/favicon.ico><title>Go Handlers and State</title><link rel=stylesheet href=https://www.aaron-torres.com/css/style.min.657bcb7af31123e4156b1a3d2ff60a636717e54ead74f882136b5114cf72b55e.css integrity="sha256-ZXvLevMRI+QVaxo9L/YKY2cX5U6tdPiCE2tRFM9ytV4=" crossorigin=anonymous></head><body id=page><header id=site-header class="animated slideInUp faster"><div class="hdr-wrapper section-inner"><div class=hdr-left><div class=site-branding><a href=https://www.aaron-torres.com>Aaron's Desk Chair Adventures</a></div><nav class="site-nav hide-in-mobile"><a href=https://www.aaron-torres.com/posts/>Posts</a></nav></div><div class="hdr-right hdr-icons"><span class="hdr-social hide-in-mobile"><a href=https://github.com/agtorre target=_blank rel="noopener me" title=Github><svg xmlns="http://www.w3.org/2000/svg" class="feather" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37.0 00-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44.0 0020 4.77 5.07 5.07.0 0019.91 1S18.73.65 16 2.48a13.38 13.38.0 00-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07.0 005 4.77a5.44 5.44.0 00-1.5 3.78c0 5.42 3.3 6.61 6.44 7A3.37 3.37.0 009 18.13V22"/></svg></a><a href=https://www.linkedin.com/in/torresaaron target=_blank rel="noopener me" title=Linkedin><svg xmlns="http://www.w3.org/2000/svg" class="feather" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M16 8a6 6 0 016 6v7h-4v-7a2 2 0 00-2-2 2 2 0 00-2 2v7h-4v-7a6 6 0 016-6z"/><rect x="2" y="9" width="4" height="12"/><circle cx="4" cy="4" r="2"/></svg></a><a href=http://twitter.com/aarontorres target=_blank rel="noopener me" title=Twitter><svg xmlns="http://www.w3.org/2000/svg" class="feather" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M23 3a10.9 10.9.0 01-3.14 1.53 4.48 4.48.0 00-7.86 3v1A10.66 10.66.0 013 4s-4 9 5 13a11.64 11.64.0 01-7 2c9 5 20 0 20-11.5a4.5 4.5.0 00-.08-.83A7.72 7.72.0 0023 3z"/></svg></a><a href=mailto:me@aaron-torres.com target=_blank rel="noopener me" title=Email><svg xmlns="http://www.w3.org/2000/svg" class="feather" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4 4h16c1.1.0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1.0-2-.9-2-2V6c0-1.1.9-2 2-2z"/><polyline points="22,6 12,13 2,6"/></svg></a></span><button id=menu-btn class=hdr-btn title=Menu><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-menu"><line x1="3" y1="12" x2="21" y2="12"/><line x1="3" y1="6" x2="21" y2="6"/><line x1="3" y1="18" x2="21" y2="18"/></svg></button></div></div></header><div id=mobile-menu class="animated fast"><ul><li><a href=https://www.aaron-torres.com/posts/>Posts</a></li></ul></div><main class="site-main section-inner animated fadeIn faster"><article class=thin><header class=post-header><div class=post-meta><span>Jun 14, 2015</span></div><h1>Go Handlers and State</h1></header><div class=content><p>Today I&rsquo;d like to get a bit technical about things I&rsquo;ve been learning and working on in the Go language</p><p>Sometimes it&rsquo;s helpful to pass additional state into a <a href=http://golang.org/pkg/net/http/#HandlerFunc>web handler function</a>. For all the examples below, lets assume you want to have a toggle for authentication that is checked once within the handler function. These functions have a specific signature and make it difficult to both add parameters and remain compatible with other libraries. There are many ways to accomplish this, including middleware with some combination of <a href=https://github.com/codegangsta/negroni>middleware</a> and <a href=http://www.gorillatoolkit.org/pkg/context>context</a> libraries. This has the advantage of allowing each request to modify the stored context value without interfering with other handlers. It&rsquo;s a bit complicated if you happen to forget to turn on the middleware and requires a diligent programmer to not hit panics inside the handler by implementing functions like DoAuth below.</p><div class=highlight><pre class=chroma><code class=language-go data-lang=go><span class=kd>type</span> <span class=nx>key</span> <span class=kt>int</span>

<span class=kd>const</span> <span class=nx>AuthKey</span> <span class=nx>key</span> <span class=p>=</span> <span class=mi>0</span>

<span class=kd>func</span> <span class=nf>UseAuth</span><span class=p>(</span><span class=nx>w</span> <span class=nx>http</span><span class=p>.</span><span class=nx>ResponseWriter</span><span class=p>,</span> <span class=nx>r</span> <span class=o>*</span><span class=nx>http</span><span class=p>.</span><span class=nx>Request</span><span class=p>,</span> <span class=nx>next</span> <span class=nx>http</span><span class=p>.</span><span class=nx>HandlerFunc</span><span class=p>){</span>
    <span class=nx>context</span><span class=p>.</span><span class=nf>Set</span><span class=p>(</span><span class=nx>r</span><span class=p>,</span> <span class=nx>AuthKey</span><span class=p>,</span> <span class=kc>true</span><span class=p>)</span>
    <span class=nf>next</span><span class=p>(</span><span class=nx>w</span><span class=p>,</span> <span class=nx>r</span><span class=p>)</span>
    <span class=nx>context</span><span class=p>.</span><span class=nf>Clear</span><span class=p>(</span><span class=nx>r</span><span class=p>)</span>
<span class=p>}</span>

<span class=kd>func</span> <span class=nf>DoAuth</span><span class=p>(</span><span class=nx>r</span> <span class=o>*</span><span class=nx>http</span><span class=p>.</span><span class=nx>Request</span><span class=p>)(</span><span class=kt>bool</span><span class=p>,</span> <span class=kt>error</span><span class=p>){</span>
    <span class=c1>// in case middle-ware isn&#39;t turned on...
</span><span class=c1></span>    <span class=k>if</span> <span class=nx>doAuth</span><span class=p>,</span> <span class=nx>ok</span> <span class=o>:=</span> <span class=nx>context</span><span class=p>.</span><span class=nf>Get</span><span class=p>(</span><span class=nx>r</span><span class=p>,</span> <span class=nx>AuthKey</span><span class=p>);</span> <span class=nx>ok</span><span class=p>{</span>
        <span class=k>return</span> <span class=nx>doAuth</span><span class=p>,</span> <span class=kc>nil</span>
    <span class=p>}</span>
    <span class=k>return</span> <span class=kc>false</span><span class=p>,</span> <span class=nx>errors</span><span class=p>.</span><span class=nf>New</span><span class=p>(</span><span class=s>&#34;middleware off&#34;</span><span class=p>)</span>
<span class=p>}</span>

<span class=kd>func</span> <span class=nf>AllTheInfo</span><span class=p>(</span><span class=nx>w</span> <span class=nx>http</span><span class=p>.</span><span class=nx>ResponseWriter</span><span class=p>,</span> <span class=nx>r</span> <span class=o>*</span><span class=nx>http</span><span class=p>.</span><span class=nx>Request</span><span class=p>){</span>
    <span class=k>if</span> <span class=nx>doAuth</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nf>DoAuth</span><span class=p>(</span><span class=nx>r</span><span class=p>);</span> <span class=nx>err</span> <span class=o>==</span> <span class=kc>nil</span> <span class=o>&amp;&amp;</span> <span class=nx>doAuth</span><span class=p>{</span>
        <span class=c1>// do something here
</span><span class=c1></span>    <span class=p>}</span>
<span class=p>}</span>

<span class=kd>func</span> <span class=nf>main</span><span class=p>(){</span>
    <span class=nx>n</span> <span class=o>:=</span> <span class=nx>negroni</span><span class=p>.</span><span class=nf>New</span><span class=p>()</span>
    <span class=nx>n</span><span class=p>.</span><span class=nf>Use</span><span class=p>(</span><span class=nx>UseAuth</span><span class=p>)</span>

    <span class=nx>mux</span> <span class=p>=</span> <span class=nx>http</span><span class=p>.</span><span class=nf>NewServeMux</span><span class=p>()</span>
    <span class=nx>mux</span><span class=p>.</span><span class=nf>HandleFunc</span><span class=p>(</span><span class=s>&#34;/&#34;</span><span class=p>,</span> <span class=nx>AllTheInfo</span><span class=p>)</span>

    <span class=nx>n</span><span class=p>.</span><span class=nf>UseHandler</span><span class=p>(</span><span class=nx>mux</span><span class=p>)</span>
    <span class=nx>n</span><span class=p>.</span><span class=nf>Run</span><span class=p>(</span><span class=s>&#34;:8000&#34;</span><span class=p>)</span>
<span class=p>}</span>
</code></pre></div><p>A simpler, but potentially less flexible approach is to use controllers. It&rsquo;s important to remember and keep in mind that controller variables should not be modified inside the handler as it will modify the controller for all other handlers that make use of it. For example, it may seem tempting to set some state based on the current request, but this is not recommended out of the box. Some examples of packages that get around this limitation by creating a controller each request include <a href=https://github.com/gocraft/web>gocraft/web</a> and this <a href=https://github.com/codegangsta/controller>controller</a> library.</p><div class=highlight><pre class=chroma><code class=language-go data-lang=go><span class=kd>type</span> <span class=nx>Controller</span> <span class=kd>struct</span><span class=p>{</span>
    <span class=nx>DoAuth</span> <span class=kt>bool</span>
<span class=p>}</span>

<span class=kd>func</span> <span class=p>(</span><span class=nx>c</span> <span class=o>*</span><span class=nx>Controller</span><span class=p>)</span> <span class=nf>AllTheInfo</span><span class=p>(</span><span class=nx>w</span> <span class=nx>http</span><span class=p>.</span><span class=nx>ResponseWriter</span><span class=p>,</span> <span class=nx>r</span> <span class=o>*</span><span class=nx>http</span><span class=p>.</span><span class=nx>Request</span><span class=p>){</span>
    <span class=k>if</span> <span class=nx>c</span><span class=p>.</span><span class=nx>DoAuth</span><span class=p>{</span>
        <span class=c1>// do something here
</span><span class=c1></span>    <span class=p>}</span>
<span class=p>}</span>

<span class=kd>func</span> <span class=nf>main</span><span class=p>(){</span>
    <span class=nx>c</span> <span class=o>:=</span> <span class=o>&amp;</span><span class=nx>Controller</span><span class=p>{</span><span class=nx>DoAuth</span><span class=p>:</span> <span class=kc>true</span><span class=p>}</span>
    <span class=nx>http</span><span class=p>.</span><span class=nf>HandleFunc</span><span class=p>(</span><span class=s>&#34;/&#34;</span><span class=p>,</span> <span class=nx>c</span><span class=p>.</span><span class=nx>AllTheInfo</span><span class=p>)</span>
    <span class=nx>http</span><span class=p>.</span><span class=nf>ListenAndServe</span><span class=p>(</span><span class=s>&#34;:8000&#34;</span><span class=p>,</span> <span class=kc>nil</span><span class=p>)</span>
<span class=p>}</span>
</code></pre></div><p>Finally, a very light-weight approach I like to make use of is closures. Closures allow the state to be modified from within the handler and are also granular enough that you can tweak them for every route without initializing additional controllers or wrapping every route with middleware incurring context look-up and reflection overhead.</p><div class=highlight><pre class=chroma><code class=language-go data-lang=go><span class=kd>func</span> <span class=nf>CheckAllTheInfo</span><span class=p>(</span><span class=nx>DoAuth</span> <span class=kt>bool</span><span class=p>)</span> <span class=kd>func</span><span class=p>(</span><span class=nx>w</span> <span class=nx>ResponseWriter</span><span class=p>,</span> <span class=nx>r</span> <span class=o>*</span><span class=nx>Request</span><span class=p>){</span>
    <span class=k>return</span> <span class=kd>func</span><span class=p>(</span><span class=nx>w</span> <span class=nx>ResponseWriter</span><span class=p>,</span> <span class=nx>r</span> <span class=o>*</span><span class=nx>Request</span><span class=p>){</span>
        <span class=k>if</span> <span class=nx>DoAuth</span><span class=p>{</span>
            <span class=c1>// do something here
</span><span class=c1></span>        <span class=p>}</span>
    <span class=p>}</span>
<span class=p>}</span>

<span class=kd>func</span> <span class=nf>main</span><span class=p>(){</span>
    <span class=nx>http</span><span class=p>.</span><span class=nf>HandleFunc</span><span class=p>(</span><span class=s>&#34;/&#34;</span><span class=p>,</span> <span class=nf>CheckAllTheInfo</span><span class=p>(</span><span class=kc>true</span><span class=p>))</span>
    <span class=nx>http</span><span class=p>.</span><span class=nf>ListenAndServe</span><span class=p>(</span><span class=s>&#34;:8000&#34;</span><span class=p>,</span> <span class=kc>nil</span><span class=p>)</span>
<span class=p>}</span>
</code></pre></div><p>Overall, there&rsquo;s a lot of ways to accomplish injecting state for web handler functions in Go. There are a number of other middleware packages besides negroni and there are even context objects build into the <a href=https://godoc.org/golang.org/x/net/context>standard library</a> now. I use combinations of all of these as one doesn&rsquo;t scratch all the itches I have. You can also combine these, for example you could attach a context object to a controller that is safe to modify or wrap a controller method in a closure.</p></div><hr class=post-end><footer class=post-info><p><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-tag meta-icon"><path d="M20.59 13.41l-7.17 7.17a2 2 0 01-2.83.0L2 12V2h10l8.59 8.59a2 2 0 010 2.82z"/><line x1="7" y1="7" x2="7" y2="7"/></svg><span class=tag><a href=https://www.aaron-torres.com/tags/development>development</a></span><span class=tag><a href=https://www.aaron-torres.com/tags/golang>golang</a></span></p><p><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-file-text"><path d="M14 2H6A2 2 0 004 4v16a2 2 0 002 2h12a2 2 0 002-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/><polyline points="10 9 9 9 8 9"/></svg>512 Words</p><p><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-calendar"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>2015-06-13 19:00 -0500</p></footer></article><div class="post-nav thin"><a class=next-post href=https://www.aaron-torres.com/posts/validation-tricks/><span class=post-nav-label><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-arrow-left"><line x1="19" y1="12" x2="5" y2="12"/><polyline points="12 19 5 12 12 5"/></svg>&nbsp;Newer</span><br><span>Go Validation Tricks</span></a>
<a class=prev-post href=https://www.aaron-torres.com/posts/moving-forward/><span class=post-nav-label>Older&nbsp;<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-arrow-right"><line x1="5" y1="12" x2="19" y2="12"/><polyline points="12 5 19 12 12 19"/></svg></span><br><span>Looking and Moving Forward</span></a></div><div id=comments class=thin></div></main><footer id=site-footer class="section-inner thin animated fadeIn faster"><p>&copy; 2020 <a href=https://www.aaron-torres.com>Aaron Torres</a></p><p>Made with <a href=https://gohugo.io/ target=_blank rel=noopener>Hugo</a> &#183; Theme <a href=https://github.com/Track3/hermit target=_blank rel=noopener>Hermit</a> &#183; <a href=https://www.aaron-torres.com/posts/index.xml target=_blank title=rss><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-rss"><path d="M4 11a9 9 0 019 9"/><path d="M4 4a16 16 0 0116 16"/><circle cx="5" cy="19" r="1"/></svg></a></p></footer><script src=https://www.aaron-torres.com/js/bundle.min.4a9a0ac3d2217822c7865b4161e6c2a71de1d70492264337755427898dd718f6.js integrity="sha256-SpoKw9IheCLHhltBYebCpx3h1wSSJkM3dVQniY3XGPY=" crossorigin=anonymous></script><script type=application/javascript>var doNotTrack=false;if(!doNotTrack){window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;ga('create','UA-8973677-3','auto');ga('send','pageview');}</script><script async src=https://www.google-analytics.com/analytics.js></script></body></html>